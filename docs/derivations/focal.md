## Weighted Focal Loss

Weighted Focal Loss applies a scaling parameter *alpha* and a focusing parameter *gamma* to [Binary Cross Entropy](https://en.wikipedia.org/wiki/Cross_entropy#Cross-entropy_loss_function_and_logistic_regression)

We take the definition of the Focal Loss from [this paper](https://arxiv.org/pdf/1708.02002.pdf):

<img src="https://latex.codecogs.com/svg.latex?L_{FL}&space;=&space;-&space;\alpha(1&space;-&space;p_{t})^{&space;\gamma}&space;\log&space;p_{t}" title="L_{FL} = - \alpha(1 - p_{t})^{ \gamma} \log p_{t}" />

where:

<img src="https://latex.codecogs.com/svg.latex?p_{t}=&space;\begin{cases}&space;\hat{y},&&space;\text{if&space;}&space;y&space;=&space;1\\&space;1&space;-&space;\hat{y},&space;&&space;\text{otherwise}&space;\end{cases}" title="p_{t}= \begin{cases} \hat{y},& \text{if } y = 1\\ 1 - \hat{y}, & \text{otherwise} \end{cases}" />

This is equivalent to writing:

<img src="https://latex.codecogs.com/svg.latex?L_{FL}&space;=&space;-&space;\alpha&space;y(1&space;-&space;\hat{y})^{\gamma}&space;\log&space;\hat{y}&space;-&space;(1&space;-&space;y)\hat{y}^{\gamma}&space;\log(1&space;-&space;\hat{y})" title="L_{FL} = - \alpha y(1 - \hat{y})^{\gamma} \log \hat{y} - (1 - y)\hat{y}^{\gamma} \log(1 - \hat{y})" />


We calculate the Gradient:

<img src="https://latex.codecogs.com/svg.latex?\begin{aligned}&space;G_{FL}(z)&space;&&space;=&space;\frac{\partial&space;L_{FL}}{\partial&space;z}&space;=&space;\frac{\partial&space;L}{\partial&space;\hat{y}}&space;\cdot&space;\frac{\partial&space;\hat{y}}{\partial&space;z}&space;\\&space;&&space;=&space;\frac{\partial&space;L}{\partial&space;\hat{y}}&space;\cdot&space;\hat{y}&space;\cdot&space;(1&space;-&space;\hat{y})&space;\\&space;&&space;=&space;(\alpha&space;\gamma&space;y&space;(1&space;-&space;\hat{y})^{\gamma&space;-&space;1}&space;\log\hat{y}&space;\\&space;&&space;-&space;\alpha\frac{y}{\hat{y}}(1&space;-&space;\hat{y})&space;\\&space;&&space;-&space;\gamma&space;(1&space;-&space;y)\hat{y}^{\gamma&space;-&space;1}&space;\log(1&space;-&space;\hat{y})&space;\\&space;&&space;&plus;&space;\frac{1&space;-&space;y}{1&space;-&space;\hat{y}}\hat{y}^{\gamma})\\&space;&&space;\cdot&space;\hat{y}&space;\cdot&space;(1&space;-&space;\hat{y})&space;\\&space;&&space;=&space;\alpha&space;y(1&space;-&space;\hat{y})^{\gamma}(\gamma\hat{y}&space;\log&space;\hat{y}&space;&plus;&space;\hat{y}&space;-&space;1)&space;&plus;&space;(1&space;-&space;y)&space;\hat{y}^{\gamma}(\gamma(\hat{y}&space;-&space;1)\log(1&space;-&space;\hat{y})&space;&plus;&space;\hat{y})&space;\end{aligned}" title="\begin{aligned} G_{FL}(z) & = \frac{\partial L_{FL}}{\partial z} = \frac{\partial L}{\partial \hat{y}} \cdot \frac{\partial \hat{y}}{\partial z} \\ & = \frac{\partial L}{\partial \hat{y}} \cdot \hat{y} \cdot (1 - \hat{y}) \\ & = (\alpha \gamma y (1 - \hat{y})^{\gamma - 1} \log\hat{y} \\ & - \alpha\frac{y}{\hat{y}}(1 - \hat{y}) \\ & - \gamma (1 - y)\hat{y}^{\gamma - 1} \log(1 - \hat{y}) \\ & + \frac{1 - y}{1 - \hat{y}}\hat{y}^{\gamma})\\ & \cdot \hat{y} \cdot (1 - \hat{y}) \\ & = \alpha y(1 - \hat{y})^{\gamma}(\gamma\hat{y} \log \hat{y} + \hat{y} - 1) + (1 - y) \hat{y}^{\gamma}(\gamma(\hat{y} - 1)\log(1 - \hat{y}) + \hat{y}) \end{aligned}" />


We also need to calculate the Hessian:

<img src="https://latex.codecogs.com/svg.latex?\begin{aligned}&space;H_{FL}(z)&space;&&space;=&space;\frac{\partial&space;G_{FL}(z)}{\partial&space;z}&space;=&space;\frac{\partial&space;G_{FL}}{\partial&space;\hat{y}}&space;\cdot&space;\frac{\partial&space;\hat{y}}{\partial&space;z}&space;\\&space;&&space;=&space;\frac{\partial&space;G_{FL}(z)}{\partial&space;\hat{y}}&space;\cdot&space;\hat{y}&space;\cdot&space;(1&space;-&space;\hat{y})&space;\\&space;&&space;=&space;(\alpha\gamma&space;y&space;(1&space;-&space;\hat{y})^{\gamma}\log\hat{y}&space;\\&space;&&space;&plus;&space;\alpha\gamma&space;y&space;(1&space;-&space;\hat{y})^{\gamma}&space;\\&space;&&space;-&space;\alpha\gamma^{2}y\hat{y}(1&space;-&space;\hat{y})^{\gamma&space;-&space;1}\log\hat{y}&space;\\&space;&&space;&plus;&space;\alpha&space;y&space;(\gamma&space;&plus;&space;1)(1&space;-&space;\hat{y})^{\gamma}&space;\\&space;&&space;-&space;\gamma^{2}(1&space;-&space;y)\hat{y}^{\gamma&space;-&space;1}\log(1&space;-&space;\hat{y})(1&space;-&space;\hat{y})&space;\\&space;&&space;&plus;&space;\gamma(1&space;-&space;y)\hat{y}^{\gamma}&space;\\&space;&&space;&plus;&space;\gamma(1&space;-&space;y)\hat{y}^{\gamma}\log(1&space;-&space;\hat{y})&space;\\&space;&&space;&plus;&space;(\gamma&space;&plus;&space;1)(1&space;-&space;y)\hat{y}^{\gamma})&space;\\&space;&&space;\cdot&space;\hat{y}&space;\cdot&space;(1&space;-&space;\hat{y})&space;\\&space;&&space;=&space;\alpha&space;y\hat{y}(1&space;-&space;y)^{\gamma}(\gamma(1&space;-&space;\hat{y})\log\hat{y}&space;&plus;&space;2\gamma(1&space;-&space;\hat{y})&space;-&space;\gamma^{2}\hat{y}\log\hat{y}&space;&plus;&space;1&space;-&space;\hat{y})&space;\\&space;&&space;&plus;&space;(1&space;-&space;y)\hat{y}^{\gamma&space;&plus;&space;1}(1&space;-&space;\hat{y})(2\gamma&space;&plus;&space;\gamma(\log(1-\hat{y}))&space;&plus;&space;1)&space;\end{aligned}" title="\begin{aligned} H_{FL}(z) & = \frac{\partial G_{FL}(z)}{\partial z} = \frac{\partial G_{FL}}{\partial \hat{y}} \cdot \frac{\partial \hat{y}}{\partial z} \\ & = \frac{\partial G_{FL}(z)}{\partial \hat{y}} \cdot \hat{y} \cdot (1 - \hat{y}) \\ & = (\alpha\gamma y (1 - \hat{y})^{\gamma}\log\hat{y} \\ & + \alpha\gamma y (1 - \hat{y})^{\gamma} \\ & - \alpha\gamma^{2}y\hat{y}(1 - \hat{y})^{\gamma - 1}\log\hat{y} \\ & + \alpha y (\gamma + 1)(1 - \hat{y})^{\gamma} \\ & - \gamma^{2}(1 - y)\hat{y}^{\gamma - 1}\log(1 - \hat{y})(1 - \hat{y}) \\ & + \gamma(1 - y)\hat{y}^{\gamma} \\ & + \gamma(1 - y)\hat{y}^{\gamma}\log(1 - \hat{y}) \\ & + (\gamma + 1)(1 - y)\hat{y}^{\gamma}) \\ & \cdot \hat{y} \cdot (1 - \hat{y}) \\ & = \alpha y\hat{y}(1 - y)^{\gamma}(\gamma(1 - \hat{y})\log\hat{y} + 2\gamma(1 - \hat{y}) - \gamma^{2}\hat{y}\log\hat{y} + 1 - \hat{y}) \\ & + (1 - y)\hat{y}^{\gamma + 1}(1 - \hat{y})(2\gamma + \gamma(\log(1-\hat{y})) + 1) \end{aligned}" />

By setting *alpha* = 1 and *gamma* = 0 we obtain the Gradient and Hessian for Binary Cross Entropy Loss, as expected.